

# Read Sutton Bonnington Data

```{r}

library(plyr)
library(tidyverse)
library(kableExtra)
library(gridExtra)

# Read data

library(readr)

absolute.path <- rprojroot::find_rstudio_root_file()
path.to.my.data <- fs::path( absolute.path
                               ,"data-ext","suttonboningtondata", ext = "txt")


suttonboningtondata <- read_table(path.to.my.data, 
    skip = 5)

# Rename the columns to something useful

new.colnames <- c( "YYYY",
                   "mm",
                   "tmax.degC",
                   "tmin.degC",
                   "airfrost.days",
                   "rain.mm",
                   "sun.hours"
  
)

colnames(suttonboningtondata) <- new.colnames

# Drop row 1
suttonboningtondata <- suttonboningtondata[-1,] 

suttonboningtondata[] <- lapply(suttonboningtondata, 
                                gsub,
                                pattern = "\\*",
                                replacement = ""
                                )


suttonboningtondata[] <- lapply(suttonboningtondata, 
                                gsub,
                                pattern = "---",
                                replacement = NA
                                )

# Date is not properly encoded so build a date from the data
suttonboningtondata$mm <-   stringr::str_pad(suttonboningtondata$mm, width = 2, pad = "0")
 
 # Create a date at the end of the month.
suttonboningtondata$dd <- 28
 suttonboningtondata$YYYYMMDD <-   with( suttonboningtondata, 
                                     paste( YYYY, mm, 
                                            dd, sep= "-"   )    )  


suttonboningtondata$datumEntity <- with(suttonboningtondata,
                                   paste("Sutton.Bonnington", YYYY, mm, sep = ":" )
                                   ) 
suttonboningtondata$place <- "Sutton Bonnington"
suttonboningtondata$lattitude <- 52.833
suttonboningtondata$logitude <- 52.833
suttonboningtondata$logitude <- -1.250
suttonboningtondata$easting <- 450700
suttonboningtondata$northing <- 325900
suttonboningtondata$height.amsl.metre <- 48



suttonbonington.triple <- suttonboningtondata %>% 
                  map_df(as.character) %>% # Convert everything to character
                  pivot_longer(!datumEntity, # Use datumEntity as the key
                  names_to = "datumAttribute", # Save the name of the attribute
                  values_to = "datumValue") # Save the value of the attribute

# Drop all the NAs from datumValue

rows.to.keep <- which(!is.na(suttonbonington.triple$datumValue)  )
 suttonbonington.triple <-  suttonbonington.triple[rows.to.keep,]


path.to.save<- fs::path( absolute.path
                               ,"data-ext","suttonboningtondata", ext = "rds")
saveRDS(suttonbonington.triple,path.to.save)


```


```{r}

# Prepare data-ss





# First prepare the long data
VC55.weather.sl <- suttonbonington.triple %>%
                  pivot_wider(
  id_cols = datumEntity,
  names_from = datumAttribute,
  values_from = datumValue)

# But we are interesting in plotting the data by year so

  VC55.weather.ss <- VC55.weather.sl %>% 
    select("YYYYMMDD", "tmax.degC","tmin.degC","airfrost.days", "sun.hours" ,"rain.mm") %>%
    pivot_longer(!YYYYMMDD,# Use datumEntity as the key
                  names_to = "datumAttribute", # Save the name of the attribute
                  values_to = "datumValue") # Save the value of the attribute



 
 # # Reorganise the names into a nice order
 # ss.colnames <- c("YYYYMMMDD",
 #                  "datumAttribute",
 #                  "value"
 # )
 # 
#VC55.weather.ss <- VC55.weather.sl

 
path.to.save.ss<- fs::path( absolute.path
                               ,"data-ss","VC55.weather.ss", ext = "rds")
saveRDS(VC55.weather.ss, path.to.save.ss)

```

```{r}

# Check plot

data.to.plot <- VC55.weather.ss

ggplot(data = VC55.weather.ss, aes(colour = factor(datumAttribute), x= YYYYMMDD, y =datumValue, group = datumAttribute) ) + 
  geom_point() +
    geom_line()



```

```{r}

# An improved summary


data.to.plot <- VC55.weather.ss

# Turn date into year
data.to.plot$Year <-format( as.Date(data.to.plot$YYYYMMDD), format = "%Y") %>% as.numeric()

data.to.plot$datumValue <- data.to.plot$datumValue %>% as.numeric()

data.to.plot <- data.to.plot %>% 
  group_by(datumAttribute) %>% 
  mutate( value = datumValue,
          Z.score = (datumValue -mean(datumValue))/sd(datumValue)
        )


  ggplot(data.to.plot, aes(colour = datumAttribute, 
              x= Year, y =Z.score, 
              group = datumAttribute) ) + 
              geom_smooth( se = FALSE, method = "loess", formula = "y ~ x") + 
    geom_point(data =data.to.plot[abs(data.to.plot$Z.score) >= 1.5,]) +
              scale_colour_viridis_d() 


  

```

