

# Read Sutton Bonnington Data

```{r}

library(plyr)
library(tidyverse)
library(kableExtra)
library(gridExtra)

# Read data

library(readr)

absolute.path <- rprojroot::find_rstudio_root_file()
path.to.my.data <- fs::path( absolute.path
                               ,"data-ext","suttonboningtondata", ext = "txt")


suttonboningtondata <- read_table(path.to.my.data, 
    skip = 5)

# Rename the columns to something useful

new.colnames <- c( "YYYY",
                   "mm",
                   "tmax.degC",
                   "tmin.degC",
                   "airfrost.days",
                   "rain.mm",
                   "sun.hours"
  
)

colnames(suttonboningtondata) <- new.colnames

# Drop row 1
suttonboningtondata <- suttonboningtondata[-1,] 

suttonboningtondata[] <- lapply(suttonboningtondata, 
                                gsub,
                                pattern = "\\*",
                                replacement = ""
                                )


suttonboningtondata[] <- lapply(suttonboningtondata, 
                                gsub,
                                pattern = "---",
                                replacement = NA
                                )

path.to.save<- fs::path( absolute.path
                               ,"data-ext","suttonboningtondata", ext = "rds")
saveRDS(suttonboningtondata,path.to.save)


```
```{r}

# Prepare data-ss

# First data sl
VC55.weather.sl <- suttonboningtondata %>% 
                  pivot_longer(!YYYY:mm, 
                  names_to = "datum.attribute", 
                  values_to = "value")


 VC55.weather.sl$mm <-   stringr::str_pad(VC55.weather.sl$mm, width = 2, pad = "0")
 
 # Create a date at the end of the month.
 VC55.weather.sl$dd <- 28
 VC55.weather.sl$YYYYMMMDD <-   with( VC55.weather.sl, 
                                     paste( YYYY, mm, 
                                            dd, sep= "-"   )    )  
 
 # Reorganise the names into a nice order
 ss.colnames <- c("YYYYMMMDD",
                  "datum.attribute",
                  "value"
 )
 
VC55.weather.ss <- VC55.weather.sl[,ss.colnames]
 
# Finally drop rows where value is NA.
# Better to keep rows which are not NA

rows.to.keep <- which(!is.na(VC55.weather.ss$value)  )
 VC55.weather.ss <-  VC55.weather.ss[rows.to.keep,]
 
 #Now save the weather
 
VC55.weather.ss$YYYYMMMDD <-   VC55.weather.ss$YYYYMMMDD %>% as.Date()
VC55.weather.ss$value <-   VC55.weather.ss$value %>% as.numeric()
 
path.to.save.ss<- fs::path( absolute.path
                               ,"data-ss","VC55.weather.ss", ext = "rds")
saveRDS(VC55.weather.ss, path.to.save.ss)

```

```{r}

# Check plot

data.to.plot <- VC55.weather.ss[VC55.weather.ss$datum.attribute == "rain.mm", ]

ggplot(data = VC55.weather.ss, aes(colour = factor(datum.attribute), x= YYYYMMMDD, y =value, group = datum.attribute) ) + 
  geom_point() +
    geom_line()



```

```{r}

# An improved summary


data.to.plot <- VC55.weather.ss

# Turn date into year
data.to.plot$Year <-  format(data.to.plot$YYYYMMMDD, format = "%Y") %>% as.numeric()



  data.to.plot %>% 
  group_by(datum.attribute) %>% 
  mutate( value = value,
          Z.score = (value -mean(value))/sd(value)
        ) %>%
  ggplot( aes(colour = datum.attribute, 
              x= Year, y =Z.score, 
              group = datum.attribute) ) + 
              geom_smooth( se = FALSE) + 
              scale_colour_viridis_d() 


```

